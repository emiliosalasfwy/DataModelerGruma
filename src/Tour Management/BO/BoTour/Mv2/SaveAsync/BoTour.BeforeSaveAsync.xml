<BusinessLogic methodName="beforeSaveAsync" businessObjectClass="BoTour" businessObjectType="{BOType}" asynchronous="true" accessibility="PUBLIC" final="false" module="CORE" simpleEditorOnly="">
  <Parameters>
    <MethodInput name="context" type="Object" />
  </Parameters>
<Code language="JavaScript">
<![CDATA[/********************************************************************************************************
  *  1 CGCloud table / 2 onPrem tables                                                                       *
  *                                                                                                       *
  *  CGCloud:    -Description is part of Tour__c                                                             *
  *           -TourObjectRelation are mapped differently.                                                 *
  *            In some cases objectMetaPKey is mapped to call template in other cases to order template.  *
  *            No "ObjectKey" concept                                                                     *
  *  onPrem:  -Separate table for description                                                             *
  *            "ObjectKey" concept. No dynamic mapping of object key                                      *
  *********************************************************************************************************/

var deferreds = [];
var changeType;
var data;
var mapping;

if(Utils.isDefined(me.getLoTourRelatedCalls()) && me.getTmgStatus()==="Open") {
  if (me.getLoTourRelatedCalls().getObjectStatus() != STATE.PERSISTED) {
    deferreds.push(Facade.saveListAsync(me.getLoTourRelatedCalls()));
  }}

if(!Utils.isEmptyString(me.getEtpVehicleTruckPKey()) && Utils.isDefined(me.getLuTruck())) {
  me.setTruckId(me.getLuTruck().getTruckId());
}
if(!Utils.isEmptyString(me.getEtpVehicleTrailer1PKey()) && Utils.isDefined(me.getLuTrailer1())) {
  me.setTrailerId(me.getLuTrailer1().getTruckId());
}
if(!Utils.isEmptyString(me.getEtpVehicleTrailer2PKey()) && Utils.isDefined(me.getLuTrailer2())) {
  me.setTrailerId2(me.getLuTrailer2().getTruckId());
}

// SF/CASDIF: General Dif
// If the backend is SalesForce, Description is part of Tour__c
if (Utils.isSfBackend()) {
  if(Utils.isDefined(me.getLoTmgTourObjectRelations())) {
    if (me.getLoTmgTourObjectRelations().getObjectStatus() != STATE.PERSISTED) {
      // Determine type of change
      if ((me.getLoTmgTourObjectRelations().getObjectStatus() & STATE.DELETED) > 0) {
        changeType = "D";
      }
      else if ((me.getLoTmgTourObjectRelations().getObjectStatus() & STATE.NEW) > 0) {
        changeType = "N";
      }
      else {
        changeType = "U";
      }

      var datasourceTourObjects = AppManager.getDataSource("LoTmgTourObjectRelations");
      var tourObjectReferences = me.getLoTmgTourObjectRelations().getAllItems();
      var CallTemplateField = "Visit_Template__c";
      var OrderTemplateField = "Order_Template__c";

      for(var i = 0; i < tourObjectReferences.length; i++) {
        var ObjectMetaPKey =  tourObjectReferences[i].getObjectMetaPKey();
        data =  tourObjectReferences[i].getData();
        mapping = Utils.clone(datasourceTourObjects.attributeToColumnMapping);

        if(tourObjectReferences[i].getUsage().indexOf("ClbMeta") >= 0) {
          mapping.objectMetaPKey = CallTemplateField;
        }
        else {
          mapping.objectMetaPKey = OrderTemplateField;
        }
        deferreds.push(Facade.putTrackedObjectInTransaction({
          name: datasourceTourObjects.objectName,
          idAttribute: datasourceTourObjects.idAttribute,
          idProperty: datasourceTourObjects.idProperty,
          mapping: mapping,
          changeType: changeType,
          data: data,
        }));
      }
    }
  }
}

if (Utils.isCasBackend()) {
  if(Utils.isDefined(me.getLoTmgTourObjectRelations())) {
    deferreds.push(Facade.saveListAsync(me.getLoTmgTourObjectRelations()));
  }
  if(Utils.isDefined(me.getLoTmgTourCheckRelations())) {
    deferreds.push(Facade.saveListAsync(me.getLoTmgTourCheckRelations()));
  }

  if(Utils.isDefined(me.getBoTruckLoad())) {
    deferreds.push(me.getBoTruckLoad().saveAsync());
  }
}

// SF/CASDIF: General Dif
// If the backend is SalesForce, Description is part of Tour__c
if (Utils.isSfBackend()) {
  // Determine type of change
  if ((me.getObjectStatus() & STATE.DELETED) > 0) {
    changeType = "D";
  }
  else if ((me.getObjectStatus() & STATE.NEW) > 0) {
    changeType = "N";
  }
  else {
    changeType = "U";
  }

  var datasource = AppManager.getDataSource("BoTour");
  var DescriptionField = "Description_" + ApplicationContext.get('user').sfLanguagePostfix + "__c";
  var Description =  me.getLoTourDescription().getAllItems()[0].getText();
  data =  me.getData();
  data.text = Description;

  //in case of normal save dateFrom/DateThru is a ANSI Datestring
  //in case od drag and drop of the call in the agenda date from is a javascript date
  if (data.dateFrom instanceof Date) {
    data.dateFrom = Utils.convertDate2Ansi(data.dateFrom);
  }
  if (data.dateThru instanceof Date) {
    data.dateThru = Utils.convertDate2Ansi(data.dateThru);
  }
  var endDate = Utils.convertAnsiDate2Date(data.dateThru.substr(0,10) + " " + data.timeThru + ":00").getTime();
  var maxDate = Utils.convertAnsiDate2Date(Utils.getMaxDate()).getTime();

  data.sf_startDateTime = Utils.convertAnsiDate2Date(data.dateFrom.substr(0,10) + " " + data.timeFrom + ":00").getTime();
  data.sf_endDateTime = (endDate > maxDate) ? maxDate:endDate;
  data.sf_startReleaseTime = Utils.unixepochToTicks(Utils.convertForDB(data.startReleaseTime, "DomDateTime"));
  data.sf_completionReleaseTime = Utils.unixepochToTicks(Utils.convertForDB(data.completionReleaseTime, "DomDateTime"));

  mapping = Utils.clone(datasource.attributeToColumnMapping);
  mapping.text = DescriptionField;
  mapping.sf_startDateTime = "Start_Date_Time__c";
  mapping.sf_endDateTime = "End_Date_Time__c";
  mapping.sf_startReleaseTime = "Start_Release_Time__c";
  mapping.sf_completionReleaseTime = "Completion_Release_Time__c";

  deferreds.push(Facade.saveTrackedObject({
    name: datasource.objectName,
    idAttribute: datasource.idAttribute,
    idProperty: datasource.idProperty,
    mapping: mapping,
    changeType: changeType,
    data: data
  }));
}
else {
  if(Utils.isDefined(me.getLoTourDescription())) {
    deferreds.push(Facade.saveListAsync(me.getLoTourDescription()));
  }
  deferreds.push(Facade.saveObjectAsync(me));
}

var promise = when.all(deferreds);]]>
</Code>
  <Return name="context" value="promise" />
</BusinessLogic>