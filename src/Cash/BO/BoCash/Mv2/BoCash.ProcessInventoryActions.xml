<BusinessLogic methodName="processInventoryActions" businessObjectClass="BoCash" businessObjectType="businessobject" asynchronous="true" accessibility="PUBLIC" final="false" module="CORE" simpleEditorOnly="">
  <Parameters />
<Code language="JavaScript">
<![CDATA[var deferreds = [];
var cashItems = me.getLoPayments();

if(Utils.isDefined(cashItems))
{
  var payments = cashItems.getAllItems();
  for(var i = 0; i< payments.length;i++)
  {
    var payment = payments[i];
    if ((payment.getAmount() !== 0) && (Utils.isEmptyString(payment.getIvcInformationObject()))) 
    {
      deferreds.push(
        me.setInventoryBalanceOfCashPayment(payment.getPKey())
      );
    }

  }
}

// Create transactions and missing inventories
var promise = when.all(deferreds).then(
  function () {

    var ivcInformationObject;
    var ivcInformation;
    var cashItem;

    // Create loInventories and loInventoryTransactions
    me.setLoInventories(BoFactory.instantiateLightweightList("LoInventory"));
    me.setLoInventoryTransactions(BoFactory.instantiateLightweightList("LoInventoryTransaction"));
    var loInventories = me.getLoInventories();
    var loInventoryTransactions = me.getLoInventoryTransactions();

    //-------------------------------------------
    // Cash inventories
    //-------------------------------------------

    if (Utils.isDefined(cashItems)) {
      // Create missing inventories and write transactions
      var cashPayments = cashItems.getAllItems();
      var cashPayment;

      for (var i = 0; i < cashPayments.length; i++) {
        cashPayment = cashPayments[i];

        if (cashPayment.getAmount() !== 0) {
          ivcInformationObject = cashPayment.getIvcInformationObject();

          //Write transaction for each inventory control template (combination of IvcMeta and IvcTaMeta)
          if (Utils.isDefined(ivcInformationObject)) {
            for (var j = 0; j < ivcInformationObject.length; j++) {
              ivcInformation = ivcInformationObject[j];

              //Create inventory if not already exists
              if (Utils.isEmptyString(ivcInformation.ivcMainPKey)) {
                ivcInformation.ivcMainPKey = loInventories.createInventoryForCashPayment(cashPayment, ivcInformation);
              }

              //Write transaction
              loInventoryTransactions.createTransactionForCashPayment(cashPayment, ivcInformation);
            }
          }
        }
      }
    }
  }
);]]>
</Code>
  <Return name="promise" value="promise" />
</BusinessLogic>