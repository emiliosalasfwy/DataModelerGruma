<BusinessLogic methodName="stateTransition" businessObjectClass="BoPromotion" businessObjectType="" asynchronous="true" accessibility="PUBLIC" final="false" module="CORE" simpleEditorOnly="">
  <Parameters>
    <MethodInput name="nextStateType" type="String" />
    <MethodInput name="nextStatePKey" type="String" />
  </Parameters>
<Code language="JavaScript">
<![CDATA[var boWorkflow = me.getBoWorkflow();

//Set new responsible
var promise = boWorkflow.getNextResponsible(nextStatePKey, me.getResponsiblePKey(), me.getOwnerPKey())
  .then(function (nextResponsible) {	
  var liRecentState;
  var jsonParamsForLookup;
  var buttonValues = {};		

  if (Utils.isDefined(nextResponsible)) {

    //Transition to next State
    me.setNextStatePKey(nextStatePKey);
    me.setResponsiblePKey(nextResponsible);

    if (boWorkflow.getRecentStatePolicy() == "1") {
      liRecentState = {
        "pKey" : PKey.next(),
        "prmPromotionPKey" : me.getPKey(),
        "usrUserPKey" : ApplicationContext.get('user').getPKey(),
        "wfeStatePKey" : me.getActualStatePKey(),
        "done" : Utils.createAnsiDateNow(),
        "objectStatus" : STATE.NEW | STATE.DIRTY
      };
      me.getLoRecentState().addListItems([liRecentState]);

    }

    //Set Phase according to WfeState Stereotype if AutoPhasing is enabled
    if (me.getLuPrmMeta().getAutoPhaseSetting() == "1") {
      me.setPhase(nextStateType);
    }

    //Finish transition
    me.setActualStatePKey(nextStatePKey);

    jsonParamsForLookup = me.prepareLookupsLoadParams({
      bpaCustomerPKey : me.getBpaCustomerPKey(),
      prmMetaPKey : me.getPrmMetaPKey(),
      initiatorPKey : me.getInitiatorPKey(),
      ownerPKey : me.getOwnerPKey(),
      responsiblePKey : me.getResponsiblePKey(),
      pKey : me.getPKey(),
      customerPKey : me.getBpaCustomerPKey(),
      referenceUserPKey : me.getResponsiblePKey(),
      referenceDate : Utils.createAnsiDateNow(),
      actualStatePKey : me.getActualStatePKey()
    });
    return Facade.loadLookupsAsync(jsonParamsForLookup)
      .then(function (lookups) {
      me.assignLookups(lookups);
      //Refresh EA-Rights
      me.setEARights();
    });

  } else {			
    buttonValues[Localization.resolve("OK")] = "ok";
    return MessageBox.displayMessage(Localization.resolve("MessageBox_Title_Error"), Localization.resolve("NoResponsibleFoundByWorkflow"), buttonValues);
  }
});]]>
</Code>
  <Return name="result" value="promise" />
</BusinessLogic>