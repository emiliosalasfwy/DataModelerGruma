<BusinessLogic methodName="cpCreateSdoConditionRecords" businessObjectClass="BoOrder" businessObjectType="" asynchronous="true" accessibility="PUBLIC" final="false" module="CORE" simpleEditorOnly="">
  <Parameters>
    <MethodInput name="PrintRelevantOnly" type="Object" />
  </Parameters>
<Code language="JavaScript">
<![CDATA[// Obsolete / unused : This function has been deprecated, we are creating Sdo Conditions in BoOrder.preparePrint method now.
var promise = when.resolve();

if (Utils.isDefined(me.getLoSdoConditions())){
  if(Utils.isSfBackend()){
    me.getLoSdoConditions().removeAllItems();
  }
  else{
    var items = me.getLoSdoConditions().getAllItems();
    for (var index = 0; index < items.length; index++){
      items[index].setObjectStatus(STATE.DIRTY | STATE.DELETED);
    }
  }
  // we do not generate pricing conditions if the generatePricingInformation on OrderMeta flag is set to no or undefined
  if (me.getCalculationStatus() == "1" && me.getDocTaType() !== "NonValuatedDeliveryNote" &&
      me.getBoOrderMeta().getGeneratePricingInformation() === "Yes"){
    var calculationPromise;
    if (Utils.isEmptyString(me.getSdoConditionsJson())){
      calculationPromise = me.cpCalculate();
    }

    promise = when(calculationPromise).then(
      function (){
        var tmpJSON = [];
        if (Utils.isDefined(me.getSdoConditionsJson()) && !Utils.isEmptyString(me.getSdoConditionsJson())){
          tmpJSON = JSON.parse(me.getSdoConditionsJson());
        }

        var newItems = [];
        if (Utils.isDefined(tmpJSON)){
          for (var i = 0; i < tmpJSON.length; i++){
            if (!PrintRelevantOnly || tmpJSON[i].PrintRelevant){
              var itemForAdd = {};
              itemForAdd.pKey = PKey.next();
              itemForAdd.sdoMainPKey = me.getPKey();
              itemForAdd.sdoItemPKey = tmpJSON[i].SdoItemPKey;
              itemForAdd.text1 = tmpJSON[i].Text1;
              itemForAdd.prdMainPKey = tmpJSON[i].PrdMainPKey;
              itemForAdd.currency = tmpJSON[i].Currency;
              itemForAdd.currencyConversionRate = tmpJSON[i].CurrencyConversionRate;

              if (!Utils.isEmptyString(tmpJSON[i].SdoItemPKey)){
                //set ErpID temporary to pkey
                //needed because printout correlates via ErpID
                //ErpIDs of SdoConditions are updated later in function setItemErpIDs
                var lstItem = me.getLoItems().getItemByPKey(tmpJSON[i].SdoItemPKey);
                if (Utils.isDefined(lstItem)){
                  if(Utils.isEmptyString(lstItem.getErpId())){
                    lstItem.setErpId(lstItem.getPKey());
                  }
                  itemForAdd.sdoItemErpId = lstItem.getErpId();
                }
              }

              itemForAdd.cndCpCalculationPosition = tmpJSON[i].CndCpCalculationPosition;
              itemForAdd.cndCpSearchStrategyKTRelPos = tmpJSON[i].CndCpSearchStrategyKTRelPos;
              itemForAdd.conditionBaseValue = tmpJSON[i].ConditionBaseValue;

              if (Utils.isEmptyString(tmpJSON[i].ConditionValue)){
                tmpJSON[i].ConditionValue = tmpJSON[i].ConvertedConditionValue;
              }

              itemForAdd.conditionValue = tmpJSON[i].ConditionValue;
              itemForAdd.conditionUnit = tmpJSON[i].ConditionUnit;
              itemForAdd.unitFactor = tmpJSON[i].UnitFactor;
              itemForAdd.convertedConditionValue = tmpJSON[i].ConvertedConditionValue;
              itemForAdd.conditionResult = tmpJSON[i].ConditionResult;
              itemForAdd.cndCpMetaPKey = tmpJSON[i].CndCpMetaPkey;

              if (tmpJSON[i].PrintRelevant){
                itemForAdd.cpIsPrintRelevant = "1";
              }
              else{
                itemForAdd.cpIsPrintRelevant = "0";
              }
              newItems.push(itemForAdd);
            }
          }

          if (newItems.length > 0){
            me.getLoSdoConditions().addItems(newItems);
            var items = me.getLoSdoConditions().getItemObjects();
            var stateDeleted = STATE.DIRTY | STATE.DELETED;
            var stateNewDirty = STATE.NEW | STATE.DIRTY;
            for (var j = 0; j < items.length; j++){
              if (items[j].getObjectStatus() !== stateDeleted){
                items[j].setObjectStatus(stateNewDirty);
              }
            }
            me.getLoSdoConditions().setObjectStatus(stateNewDirty);
          }
        }
      });
  }
}]]>
</Code>
  <Return name="result" value="promise" />
</BusinessLogic>