<BusinessLogic methodName="createPrintInvoicePDF" businessObjectClass="BoOrder" businessObjectType="businessobject" asynchronous="true" accessibility="PUBLIC" final="false" module="CORE" simpleEditorOnly="">
  <Parameters>
    <MethodInput name="finalPath" type="String" />
    <MethodInput name="blobPkey" type="String" />
  </Parameters>
<Code language="JavaScript">
<![CDATA[var loadLoAttachmentsPromise = when.resolve();
if (!Utils.isDefined(me.getLoOrderAttachment())) {
  loadLoAttachmentsPromise = BoFactory.loadObjectByParamsAsync(LO_ORDERATTACHMENT, me.getQueryBy("sdoMainPKey", me.getPKey())).then(
    function (loAttachments) {
      me.setLoOrderAttachment(loAttachments);
    });
}

var promise = loadLoAttachmentsPromise.then(
  function () {
    var curDate = Utils.createDateNow();
    var dateExtension = "_" + (curDate.getUTCMonth() + 1) + "_" + curDate.getUTCDate() + "_" + curDate.getUTCFullYear();
    var fileType = Utils.getFileExtensionFromMediaPath(finalPath);

    var liNewAttachment = {
      "pKey": PKey.next(),
      "sdoMainPKey": me.getPKey(),
      "attachmentBlobPKey": blobPkey,
      "usage": "Printout",
      "attachmentText": "Print Document",
      "type": fileType,
      "fileName": "Print_Document_" + me.getPKey() + dateExtension + "." + fileType,
      "mediapath": finalPath,
      "creationDate": Utils.convertDate2Ansi(curDate),
      "objectStatus": STATE.NEW | STATE.DIRTY
    };
    me.getLoOrderAttachment().addItems([liNewAttachment]);
  });]]>
</Code>
  <Return name="promise" value="promise" />
</BusinessLogic>