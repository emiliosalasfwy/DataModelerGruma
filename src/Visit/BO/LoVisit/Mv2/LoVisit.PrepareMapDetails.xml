<BusinessLogic methodName="prepareMapDetails" businessObjectClass="LoVisit" businessObjectType="listobject" asynchronous="true" accessibility="PUBLIC" final="false" module="CORE" simpleEditorOnly="">
  <Parameters>
    <MethodInput name="visitList" type="Object" />
    <MethodInput name="pKey" type="String" />
  </Parameters>
<Code language="JavaScript">
<![CDATA[var visit = visitList.getItemByPKey(pKey);
var mapDetail = BoFactory.instantiate("LuMapDetail");
var distanceUnit = ApplicationContext.get('user').getDistanceUnit();
var distance = 0;
var positionPromise = when.resolve();

positionPromise = Utils.getCurrentPosition();


mapDetail.setPKey(visit.getPKey());
mapDetail.setName(visit.retailStoreName);
mapDetail.setMainAddress(visit.combinedAddress);

var promise = positionPromise.then(function (currentPosition) {
  if (Utils.isDefined(currentPosition) && Utils.isDefined(currentPosition.latitude) && Utils.isDefined(currentPosition.longitude)) {
    distance = Utils.distanceBetween(currentPosition.latitude, currentPosition.longitude, visit.latitude, visit.longitude, distanceUnit);
    distance = Utils.round(distance, 2, 1) + " " + distanceUnit;
    mapDetail.setDistance(distance);
  }
  else {
    mapDetail.setDistance(" ");
  }
  return mapDetail;
});]]>
</Code>
  <Return name="mapDetail" value="promise" />
</BusinessLogic>