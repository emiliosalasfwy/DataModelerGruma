<BusinessLogic methodName="getCurrentDate" businessObjectClass="LoAgendaOverview" businessObjectType="" asynchronous="true" accessibility="PUBLIC" final="false" module="CORE" simpleEditorOnly="">
  <Parameters>
    <MethodInput name="currentDate" type="DomDate" />
  </Parameters>
<Code language="JavaScript">
<![CDATA[var promise;

if(Utils.isDefined(ApplicationContext.get('currentTourPKey')) && !Utils.isEmptyString(ApplicationContext.get('currentTourPKey')) &&
   Utils.isDefined(ApplicationContext.get('currentTourStatus')) && ApplicationContext.get('currentTourStatus') === "Running"){

  promise = BoFactory.loadObjectByParamsAsync("LoTourRelatedCalls", {"TmgMainPKey" : ApplicationContext.get('currentTourPKey')})
    .then(function(lo){
    if(Utils.isDefined(lo) && lo.getAllItems().length > 0){
      var itms = lo.getAllItems().sort(function(a,b){    
        return (Utils.convertAnsiDate2Date(a.getDateFrom()) === Utils.convertAnsiDate2Date(b.getDateFrom())) ? 0 : ((Utils.convertAnsiDate2Date(a.getDateFrom()) < Utils.convertAnsiDate2Date(b.getDateFrom())) ? -1 : 1);
      }); 

      currentDate = Utils.convertAnsiDate2Date(itms[0].getDateFrom());
      currentDate.setHours(0,0,0,0);    

    }else{
      currentDate = Utils.createDateNow();
      currentDate.setHours(0,0,0,0);
    }

    return Utils.convertFullDate2Ansi(currentDate);
  });

}else{
  if(!Utils.isDefined(currentDate)) {
    currentDate = Utils.createAnsiDateToday();
  }
  promise = when.resolve(currentDate);
}]]>
</Code>
  <Return name="promise" value="promise" />
</BusinessLogic>